<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PredicciÃ³n ClimÃ¡tica</title>
  <link rel="stylesheet" href="/static/css/styles.css">
  <style>
    select {
      margin: 8px 0;
      padding: 5px;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <header>
    <a href="/"><img src="/static/weather.png" alt="Logo" class="logo"></a>
    <h1>PredicciÃ³n de datos del clima</h1>
  </header>
  <main>
    <div class="container">
      <div class="div_predicciones">

        <!-- DATOS SENSOR -->
        <div>
          <h2>Datos percibidos (sensor)</h2>
          <div class="card">
            <table class="table">
              <thead><tr><th>MÃ©trica</th><th>Valor</th><th>Unidad</th></tr></thead>
              <tbody>
                <tr><td>Temperatura</td><td>-</td><td>Â°C</td></tr>
                <tr><td>Humedad</td><td>-</td><td>%</td></tr>
                <tr><td>PresiÃ³n</td><td>-</td><td>hPa</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- DATOS PREDECIDOS -->
        <div>
          <h2>Predicciones futuras</h2>
          <label class="select-label" for="horasSelect">Predecir hasta:</label>
          <select id="horasSelect">
            <option value="1">1 hora</option>
            <option value="2">2 horas</option>
            <option value="3">3 horas</option>
            <option value="4">4 horas</option>
            <option value="5">5 horas</option>
            <option value="6" selected>6 horas</option>
          </select>
          <button id="btnPredecir">Generar predicciones</button>
          <div id="statusMessage" style="margin-top: 10px; font-weight: bold;"></div>

          <div class="card">
            <table class="table" id="tabla_predicciones">
              <thead><tr><th>Hora (+)</th><th>Temperatura (Â°C)</th><th>Humedad (%)</th><th>PresiÃ³n (hPa)</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- CLIMA REAL -->
        <div>
          <h2>Datos reales (clima actual)</h2>
          <div class="card">
            <table class="table">
              <thead><tr><th>MÃ©trica</th><th>Valor</th><th>Unidad</th></tr></thead>
              <tbody>
                <tr><td>Temperatura</td><td>-</td><td>Â°C</td></tr>
                <tr><td>Humedad</td><td>-</td><td>%</td></tr>
                <tr><td>PresiÃ³n</td><td>-</td><td>hPa</td></tr>
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </main>

  <script>
  async function fetchLatestSensor() {
    try {
      const resp = await fetch('/api/sensor/latest?limit=1');
      const data = await resp.json();
      if (data && data.length) {
        const latest = data[0];
        const card = document.querySelectorAll('.div_predicciones .card')[0];
        card.querySelectorAll('tbody tr')[0].cells[1].innerText = latest.temperatura.toFixed(2);
        card.querySelectorAll('tbody tr')[1].cells[1].innerText = latest.humedad.toFixed(2);
        card.querySelectorAll('tbody tr')[2].cells[1].innerText = latest.presion ? latest.presion.toFixed(2) : '-';
      }
    } catch (e) {
      console.error('Error fetchLatestSensor', e);
      // Mostrar error visual en la tabla
      const card = document.querySelectorAll('.div_predicciones .card')[0];
      card.querySelectorAll('tbody tr').forEach(row => {
        row.cells[1].innerText = 'Error';
      });
    }
  }

  async function fetchFuturePredictions(limit) {
    try {
      const resp = await fetch(`/api/predictions/future?limit=${limit}`);
      const data = await resp.json();
      const tbody = document.querySelector('#tabla_predicciones tbody');
      tbody.innerHTML = '';
      if (data && data.length) {
        data.forEach((pred, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>+${idx + 1} h</td>
            <td>${pred.temperatura_pred?.toFixed(2) ?? '-'}</td>
            <td>${pred.humedad_pred?.toFixed(2) ?? '-'}</td>
            <td>${pred.presion_pred?.toFixed(2) ?? '-'}</td>
          `;
          tbody.appendChild(tr);
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="4">Sin datos</td></tr>';
      }
    } catch (e) {
      console.error('Error fetchFuturePredictions', e);
    }
  }

  async function runPrediction(horas) {
    const statusDiv = document.getElementById('statusMessage');
    const btnPredecir = document.getElementById('btnPredecir');
    
    try {
      statusDiv.style.color = '#2196F3';
      statusDiv.innerText = 'ðŸ”„ Generando predicciones...';
      btnPredecir.disabled = true;
      
      // Obtener cantidad de predicciones antes
      const respBefore = await fetch('/api/predictions/future?limit=1');
      const dataBefore = await respBefore.json();
      const countBefore = dataBefore.length;
      
      const resp = await fetch('/api/predict', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ horas_futuro: horas })
      });
      const result = await resp.json();
      console.log(result.message);
      
      statusDiv.innerText = 'â³ Procesando datos...';
      
      // Esperamos unos segundos para que el hilo termine
      setTimeout(async () => {
        // Verificar si realmente se generaron predicciones nuevas
        const respAfter = await fetch('/api/predictions/future?limit=1');
        const dataAfter = await respAfter.json();
        const countAfter = dataAfter.length;
        
        if (countAfter > countBefore || (dataAfter.length > 0 && dataBefore.length > 0 && dataAfter[0].prediction_time !== dataBefore[0].prediction_time)) {
          await fetchFuturePredictions(horas);
          statusDiv.style.color = '#4CAF50';
          statusDiv.innerText = 'âœ“ Predicciones actualizadas correctamente';
        } else {
          statusDiv.style.color = '#f44336';
          statusDiv.innerText = 'âœ— Error: No se generaron predicciones. Verifica los logs del servidor.';
        }
        
        btnPredecir.disabled = false;
        
        // Limpiar mensaje despuÃ©s de 5 segundos
        setTimeout(() => {
          statusDiv.innerText = '';
        }, 5000);
      }, 4000);
    } catch (e) {
      console.error('Error runPrediction', e);
      statusDiv.style.color = '#f44336';
      statusDiv.innerText = 'âœ— Error al generar predicciones: ' + e.message;
      btnPredecir.disabled = false;
      
      setTimeout(() => {
        statusDiv.innerText = '';
      }, 5000);
    }
  }

  async function fetchRealWeather() {
    try {
      const resp = await fetch('/api/weather/real');
      const real = await resp.json();
      if (real) {
        const card = document.querySelectorAll('.div_predicciones .card')[2];
        card.querySelectorAll('tbody tr')[0].cells[1].innerText = real.temperatura.toFixed(2);
        card.querySelectorAll('tbody tr')[1].cells[1].innerText = real.humedad.toFixed(2);
        card.querySelectorAll('tbody tr')[2].cells[1].innerText = real.presion ? real.presion.toFixed(2) : '-';
      }
    } catch (e) {
      console.error('Error fetchRealWeather', e);
      // Mostrar error visual en la tabla
      const card = document.querySelectorAll('.div_predicciones .card')[2];
      card.querySelectorAll('tbody tr').forEach(row => {
        row.cells[1].innerText = 'Error';
      });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const selectHoras = document.getElementById('horasSelect');
    const btnPredecir = document.getElementById('btnPredecir');

    fetchLatestSensor();
    fetchFuturePredictions(parseInt(selectHoras.value));
    fetchRealWeather();

    btnPredecir.addEventListener('click', () => {
      const horas = parseInt(selectHoras.value);
      runPrediction(horas);
    });

    setInterval(() => {
      fetchLatestSensor();
      fetchRealWeather();
    }, 60 * 1000);
  });
  </script>
</body>
</html>
