<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Monitoreo Climático</title>
  <link rel="stylesheet" href="/static/css/styles_new.css">
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <header class="header">
    <div class="header-container">
      <div class="header-brand">
        <img src="/static/weather.png" alt="Logo" class="header-logo">
        <div class="header-text">
          <h1 class="header-title">Sistema de Monitoreo Climático</h1>
          <p class="header-subtitle">Predicción inteligente en tiempo real</p>
        </div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <div class="container">
      
      <div class="dashboard-grid">
        
        <div class="dashboard-card sensor-card">
          <div class="card-header">
            <div class="card-title">
              <h2>Datos del Sensor</h2>
            </div>
            <div class="card-time">
              <span class="time-label">Hora actual:</span>
              <span id="current-time" class="time-value"></span>
            </div>
          </div>
          <div class="card-content">
            <div class="metrics-grid">
              <div class="metric-item">
                <div class="metric-icon temperature">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/>
                  </svg>
                </div>
                <div class="metric-data">
                  <span class="metric-value" id="temp-value">--</span>
                  <span class="metric-unit">°C</span>
                  <span class="metric-label">Temperatura</span>
                </div>
              </div>
              <div class="metric-item">
                <div class="metric-icon humidity">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
                  </svg>
                </div>
                <div class="metric-data">
                  <span class="metric-value" id="humidity-value">--</span>
                  <span class="metric-unit">%</span>
                  <span class="metric-label">Humedad</span>
                </div>
              </div>
              <div class="metric-item">
                <div class="metric-icon pressure">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m12 14 4-4"/>
                    <path d="M3.34 19a10 10 0 1 1 17.32 0"/>
                  </svg>
                </div>
                <div class="metric-data">
                  <span class="metric-value" id="pressure-value">--</span>
                  <span class="metric-unit">hPa</span>
                  <span class="metric-label">Presión</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="dashboard-card prediction-card">
          <div class="card-header">
            <div class="card-title">
              <h2>Generar Predicción</h2>
            </div>
          </div>
          <div class="card-content">
            <div class="prediction-controls">
              <div class="control-group">
                <label for="horasSelect" class="control-label">Horizonte de predicción:</label>
                <div class="select-wrapper">
                  <select id="horasSelect" class="custom-select">
                    <option value="1">1 hora</option>
                    <option value="2">2 horas</option>
                    <option value="3">3 horas</option>
                    <option value="4">4 horas</option>
                    <option value="5">5 horas</option>
                    <option value="6" selected>6 horas</option>
                  </select>
                </div>
              </div>
              
              <button id="btnPredecir" class="btn-primary">
                <span>Generar Predicciones</span>
              </button>
              
              <div id="statusMessage" class="status-message"></div>
            </div>
          </div>
        </div>

        <div class="dashboard-card predictions-card">
          <div class="card-header">
            <div class="card-title">
              <h2>Predicciones Futuras</h2>
            </div>
          </div>
          <div class="card-content">
            <div class="table-container">
              <table class="data-table" id="tabla_predicciones">
                <thead>
                  <tr>
                    <th>Tiempo</th>
                    <th>Temperatura</th>
                    <th>Confianza</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="empty-state">
                    <td colspan="3">
                      <div class="empty-content">
                        <p>No hay predicciones disponibles</p>
                        <span>Genera nuevas predicciones para ver los datos</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2025 Sistema de Monitoreo Climático - Universidad Andrés Bello (UNAB)</p>
    </div>
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const selectHoras = document.getElementById('horasSelect');
    const btnPredecir = document.getElementById('btnPredecir');

    updateCurrentTime();
    // Update time every second
    setInterval(updateCurrentTime, 1000);

    // Initial data load
    fetchLatestSensor();
    fetchFuturePredictions(parseInt(selectHoras.value));

    // Event listeners
    selectHoras.addEventListener('change', () => {
      const horas = parseInt(selectHoras.value);
      fetchFuturePredictions(horas);
    });

    btnPredecir.addEventListener('click', () => {
      const horas = parseInt(selectHoras.value);
      runPrediction(horas);
    });

    // Auto-refresh sensor data every minute
    setInterval(() => {
      fetchLatestSensor();
    }, 60 * 1000);
  });

  async function fetchLatestSensor() {
    try {
      const resp = await fetch('/api/sensor/latest?limit=1');
      const data = await resp.json();
      
      if (data && data.length) {
        const latest = data[0];
        // Update metric values with new structure
        document.getElementById('temp-value').textContent = latest.temperatura.toFixed(1);
        document.getElementById('humidity-value').textContent = latest.humedad.toFixed(1);
        document.getElementById('pressure-value').textContent = latest.presion ? latest.presion.toFixed(1) : '--';
        
        // Update status indicator
        updateConnectionStatus(true);
      } else {
        // No data available
        document.getElementById('temp-value').textContent = '--';
        document.getElementById('humidity-value').textContent = '--';
        document.getElementById('pressure-value').textContent = '--';
        updateConnectionStatus(false);
      }
    } catch (e) {
      console.error('Error fetchLatestSensor', e);
      updateConnectionStatus(false);
    }
  }

  async function fetchFuturePredictions(limit) {
    try {
      const minutosNecesarios = limit * 60;
      const resp = await fetch(`/api/predictions/future?limit=${minutosNecesarios}`);
      const data = await resp.json();
      const tbody = document.querySelector('#tabla_predicciones tbody');
      
      // Clear existing content
      tbody.innerHTML = '';
      
      if (data && data.length >= minutosNecesarios) {
        // Group by hour (average every 60 minutes)
        const horasAgrupadas = [];
        for (let hora = 0; hora < limit; hora++) {
          const inicioIdx = hora * 60;
          const finIdx = inicioIdx + 60;
          const minutosHora = data.slice(inicioIdx, finIdx);
          
          if (minutosHora.length === 60) {
            const tempPromedio = minutosHora.reduce((sum, pred) => sum + pred.temperatura_pred, 0) / 60;
            horasAgrupadas.push({
              hora: hora + 1,
              temperatura_promedio: tempPromedio,
              confidence: 0.85 + (Math.random() * 0.1) // Mock confidence for demo
            });
          }
        }
        
        if (horasAgrupadas.length > 0) {
          horasAgrupadas.forEach((horaData) => {
            const tr = document.createElement('tr');
            tr.className = 'data-row';
            tr.innerHTML = `
              <td class="time-cell">+${horaData.hora}h</td>
              <td class="temp-cell">${horaData.temperatura_promedio.toFixed(1)}°C</td>
              <td class="confidence-cell">
                <div class="confidence-bar">
                  <div class="confidence-fill" style="width: ${(horaData.confidence * 100)}%"></div>
                  <span class="confidence-text">${(horaData.confidence * 100).toFixed(0)}%</span>
                </div>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          showEmptyState('Datos insuficientes');
        }
      } else {
        showEmptyState(`Sin predicciones para ${limit} horas`);
      }
    } catch (e) {
      console.error('Error fetchFuturePredictions', e);
      showEmptyState('Error al cargar predicciones');
    }
  }

  async function runPrediction(horas) {
    const statusDiv = document.getElementById('statusMessage');
    const btnPredecir = document.getElementById('btnPredecir');
    
    try {
      // Update UI state
      showLoadingState();
      updateButtonState(btnPredecir, 'loading');
      showStatusMessage('Iniciando predicción...', 'info');
      
      const resp = await fetch('/api/predict', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ horas_futuro: horas })
      });
      const result = await resp.json();
      
      showStatusMessage('Procesando datos... Esto puede tardar varios minutos', 'warning');
      
      // Polling for results
      let attempts = 0;
      const maxAttempts = 60;
      const checkInterval = 5000;
      let lastCheckTime = null;
      
      const checkPredictions = async () => {
        attempts++;
        
        try {
          const respAfter = await fetch('/api/predictions/future?limit=1');
          const dataAfter = await respAfter.json();
          const countAfter = dataAfter.length;
          const currentPredictionTime = dataAfter.length > 0 ? dataAfter[0].prediction_time : null;
          
          const hasNewPredictions = countAfter > 0 && 
                                    (lastCheckTime === null || currentPredictionTime !== lastCheckTime);
          
          if (currentPredictionTime) {
            lastCheckTime = currentPredictionTime;
          }
          
          if (hasNewPredictions) {
            await fetchFuturePredictions(horas);
            showStatusMessage('¡Predicciones generadas exitosamente!', 'success');
            updateButtonState(btnPredecir, 'normal');
            
            setTimeout(() => {
              hideStatusMessage();
            }, 5000);
          } else if (attempts >= maxAttempts) {
            showStatusMessage('Tiempo de espera agotado. Intenta nuevamente.', 'error');
            updateButtonState(btnPredecir, 'normal');
            showEmptyState();
          } else {
            const secondsElapsed = attempts * 5;
            const minutesElapsed = Math.floor(secondsElapsed / 60);
            const secondsRemaining = secondsElapsed % 60;
            const timeDisplay = minutesElapsed > 0 
              ? `${minutesElapsed}m ${secondsRemaining}s` 
              : `${secondsElapsed}s`;
            
            showStatusMessage(`Procesando datos... (${timeDisplay} / 5min)`, 'warning');
            setTimeout(checkPredictions, checkInterval);
          }
        } catch (e) {
          console.error('Error checking predictions', e);
          showStatusMessage('Error verificando predicciones', 'error');
          updateButtonState(btnPredecir, 'normal');
        }
      };
      
      setTimeout(checkPredictions, 10000);
      
    } catch (e) {
      console.error('Error runPrediction', e);
      showStatusMessage('Error al generar predicciones', 'error');
      updateButtonState(btnPredecir, 'normal');
    }
  }

  // Helper functions
  function updateConnectionStatus(isOnline) {
    const statusIndicator = document.querySelector('.status-indicator');
    const statusText = document.querySelector('.status-text');
    
    if (isOnline) {
      statusIndicator.className = 'status-indicator online';
      statusText.textContent = 'En línea';
    } else {
      statusIndicator.className = 'status-indicator offline';
      statusText.textContent = 'Sin conexión';
    }
  }

  function showStatusMessage(message, type) {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.className = `status-message ${type}`;
    statusDiv.textContent = message;
    statusDiv.style.display = 'block';
  }

  function hideStatusMessage() {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.style.display = 'none';
  }

  function updateButtonState(button, state) {
    const emoji = button.querySelector('.btn-emoji');
    const text = button.querySelector('span:last-child');
    
    switch(state) {
      case 'loading':
        button.disabled = true;
        button.classList.add('loading');
        emoji.textContent = '⏳';
        text.textContent = 'Generando...';
        break;
      case 'normal':
        button.disabled = false;
        button.classList.remove('loading');
        emoji.textContent = '▶️';
        text.textContent = 'Generar Predicciones';
        break;
    }
  }

  function showLoadingState() {
    const tbody = document.querySelector('#tabla_predicciones tbody');
    tbody.innerHTML = `
      <tr class="loading-state">
        <td colspan="3">
          <div class="loading-content">
            <div class="spinner"></div>
            <p>Generando predicciones...</p>
          </div>
        </td>
      </tr>
    `;
  }

  function showEmptyState(message = 'No hay predicciones disponibles') {
    const tbody = document.querySelector('#tabla_predicciones tbody');
    tbody.innerHTML = `
      <tr class="empty-state">
        <td colspan="3">
          <div class="empty-content">
            <p>${message}</p>
            <span>Genera nuevas predicciones para ver los datos</span>
          </div>
        </td>
      </tr>
    `;
  }

  // Function to update current time
  function updateCurrentTime() {
    const timeElement = document.getElementById('current-time');
    if (timeElement) {
      const now = new Date();
      const options = {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      };
      timeElement.textContent = now.toLocaleTimeString('es-ES', options);
    }
  }

  </script>
</body>
</html>
